## 트러블슈팅: 게임 종료 후 대기실 복귀 시 카메라 문제

* **작성자:** [고동현](https://github.com/rhehdgus8831)

-----

### 1\. 문제 현상 (Problem)

> 실시간 퀴즈 게임 종료 후 "방으로 돌아가기" 버튼을 눌러 대기실로 복귀 시, 본인 카메라는 보이지 않고 이전에 게임했던 상대방 카메라가 보이는 문제 발생

* **문제 1**: 대기실 화면에서 내 카메라 영상이 표시되지 않음 (검은 화면)
* **문제 2**: 아직 대기실로 복귀하지 않은 상대방의 카메라 영상이 내 화면에 표시됨
* **문제 3**: 전체적인 대기실 UI 렌더링이 불안정하고 깨져 보임

<br>

**[문제 상황 스크린샷 및 로그]**

> 게임 종료 후 대기실로 돌아왔을 때, 내 비디오(좌측 상단)는 랜더링 X, 아직 게임방에 있는 다른 참가자(우측 상단)의 비디오가 보이는 상황

<img width="525" height="258" alt="dh-ts-1" src="https://github.com/user-attachments/assets/40e4e8af-1731-4972-85e6-ee7836acd099" />


-----

### 2\. 원인 분석 (Analysis)

> 게임 종료 및 대기실 복귀 과정에서 Janus WebRTC 관련 리소스(Publisher, Remote Feeds, Session)가 완전히 정리되지 않고 남아있어, 대기실 재진입 시 이전 상태가 꼬인 것이 원인

* **원인 1: Janus Publisher 및 세션 미정리**
    * 게임 종료 시(`handleGameEnd`) Remote Feeds(상대방 영상)만 정리하고, Publisher(내 영상 송출 플러그인)와 Janus 세션 자체는 정리하지 않음
    * 이로 인해 Janus 서버의 가상 룸에는 여전히 내 Publisher가 남아있는 상태가 됨
* **원인 2: 대기실 재입장 시 자동 구독 발생**
    * 대기실로 돌아와 `useWaitingRoomJanus` 훅이 다시 실행되면서 Janus 룸에 재입장
    * Janus 서버는 해당 룸에 남아있던 이전 게임의 Publisher들(나 포함, 아직 안 나간 상대방 포함)의 정보를 새 참가자(다시 돌아온 나)에게 알려줌 ("기존 참가자가 있네요\!")
    * 클라이언트는 이 정보를 받아 자동으로 상대방 Feed를 구독하면서, 아직 대기실에 없는 상대방 영상이 보이게 됨
* **원인 3: 로컬 비디오 스트림 연결 타이밍 문제**
    * 대기실 복귀 시 로컬 비디오(`localVideoRef`)에 스트림을 다시 연결하는 과정에서, `video` 엘리먼트가 완전히 렌더링되기 전에 `attachStream`이 실행되어 연결 실패 가능성 존재 (이전 트러블슈팅과 유사)

-----

### 3\. 해결 방안 (Solution)

> 게임 종료 및 대기실 복귀 시 Janus 관련 모든 리소스를 명시적으로 정리하고, 로컬 비디오 연결 시 렌더링 완료를 기다리는 재시도 로직 추가

* **[해결 방안 1]**: 게임 종료(`handleGameEnd`) 시, 모든 Remote Feeds를 정리하는 것 외에도 **Publisher가 Janus 룸을 떠나도록(`leave` 요청 전송)** 로직 추가
* **[해결 방안 2]**: 대기실 컴포넌트(`QuizWaitingRoom`) 언마운트 시 또는 대기실 복귀 로직(`returnToWaitingRoom`) 실행 시, \*\*Janus 세션 자체를 완전히 종료(`janus.destroy()`)\*\*하고 관련 상태(`remoteStreams`, `isJanusConnected` 등)를 초기화하는 정리(cleanup) 로직 강화
* **[해결 방안 3]**: 대기실에서 로컬 비디오 엘리먼트(`localVideoRef`)에 스트림을 연결할 때, ref가 유효하지 않으면 **`setTimeout`을 이용해 짧은 지연 후 재시도**하는 방어 코드 추가

-----

### 4\. 교훈 (Lessons Learned)

> WebRTC 기반 멀티플레이 환경에서는 페이지 이동이나 상태 변경 시 관련 리소스(세션, 플러그인, 스트림 등)를 \*\*명시적이고 완전하게 정리(cleanup)\*\*하는 것이 매우 중요함

* **[교훈 1]**: Janus WebRTC 사용 시, 단순히 화면에서 영상을 지우는 것을 넘어 서버와의 연결(`plugin detach`, `session destroy`)까지 확실하게 끊어야 의도치 않은 재연결 및 상태 꼬임 문제를 방지할 수 있음
* **[교훈 2]**: React 컴포넌트 라이프사이클(마운트/언마운트)과 비동기 WebRTC 이벤트 처리(스트림 수신 등) 간의 동기화 문제를 인지하고, 정리(cleanup) 로직을 `useEffect`의 반환 함수나 적절한 이벤트 핸들러 내부에 구현해야 함
* **[교훈 3]**: 복잡한 상태를 가지는 실시간 통신 기능 구현 시, 문제 발생 지점(게임 종료, 대기실 복귀 등)을 명확히 정의하고 각 단계별로 상태 변화와 리소스 정리가 예상대로 이루어지는지 로그 등을 통해 철저히 검증하는 습관이 중요함

